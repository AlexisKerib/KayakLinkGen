<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kayak Link Generator</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css" id="flatpickr-theme">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            /* Light Theme */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-secondary: #4b5563;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --border-color: #e5e7eb;
            --input-bg: #f9fafb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.75rem;
            --accent: #10b981;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-main: #f9fafb;
            --text-secondary: #9ca3af;
            --primary: #60a5fa;
            --primary-hover: #3b82f6;
            --border-color: #374151;
            --input-bg: #374151;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --accent: #34d399;
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
            letter-spacing: -0.025em;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow);
        }

        .theme-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Cards and Layout */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .card h2 {
            margin-top: 0;
            font-size: 1.25rem;
            color: var(--primary);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        /* Forms & Inputs */
        label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            display: block;
        }

        input[type="text"],
        input[type="date"],
        select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 0.625rem;
            border-radius: 0.5rem;
            width: 100%;
            font-size: 0.95rem;
            outline: none;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Flex Groups for Dates */
        .date-row {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 1rem;
        }

        /* Map Section */
        #mapContainer {
            border-radius: var(--radius);
            overflow: hidden;
            border: 2px solid var(--border-color);
            height: 450px;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .map-mode-btns {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            background: var(--input-bg);
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: fit-content;
        }

        .map-mode-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .map-mode-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Custom Table Styling for Checkboxes */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }

        th {
            text-align: left;
            padding: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            background: var(--input-bg);
            border-radius: 0.375rem 0.375rem 0 0;
        }

        td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        td:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        /* Compact layout for Depart From section */
        #departFromContainer table {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        #departFromContainer tr {
            display: contents;
        }

        #departFromContainer th {
            display: none;
        }

        #departFromContainer td {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--input-bg);
        }

        #departFromContainer td:hover {
            border-color: var(--primary);
        }

        /* Checkbox styling enhancement */
        input[type="checkbox"] {
            accent-color: var(--primary);
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .checkbox-label {
            cursor: pointer;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
        }

        /* Collapsible */
        .collapsible-header {
            width: 100%;
            text-align: left;
            background-color: var(--input-bg);
            color: var(--text-main);
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }

        .collapsible-header:hover {
            background-color: var(--border-color);
        }

        .collapsible-header::after {
            content: '+';
            font-size: 1.25rem;
        }

        .collapsible-header.active::after {
            content: '-';
        }

        .collapsible-content {
            display: none;
            padding: 1rem 0;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        .collapsible-content.open {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Generated Link Section */
        #generatedLink {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--primary);
            margin-top: 2rem;
            word-break: break-all;
            position: sticky;
            bottom: 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: all 0.3s ease;
        }

        #generatedLink.collapsed {
            padding: 0.75rem 1.5rem;
        }

        #generatedLink .link-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        #generatedLink .link-header:hover {
            opacity: 0.8;
        }

        #generatedLink .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        #generatedLink.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        #generatedLink .link-content-wrapper {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, margin-top 0.3s ease;
            margin-top: 10px;
        }

        #generatedLink.collapsed .link-content-wrapper {
            max-height: 0;
            margin-top: 0;
        }

        #generatedLink a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            display: block;
            margin-bottom: 0.5rem;
        }

        #generatedLink a:hover {
            text-decoration: underline;
        }

        /* Utility Buttons */
        .action-btn {
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }

        .action-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Custom Map Popup */
        .leaflet-popup-content-wrapper {
            background: var(--card-bg) !important;
            color: var(--text-main) !important;
            border-radius: var(--radius) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
            padding: 0 !important;
            border: 1px solid var(--border-color);
        }

        .leaflet-popup-tip {
            background: var(--card-bg) !important;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            line-height: 1.5;
        }

        .airport-popup {
            padding: 12px 16px;
            min-width: 160px;
        }

        .airport-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .airport-popup-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-main);
        }

        .airport-popup-iata {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .airport-popup-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: var(--text-light);
        }

        .airport-popup-status {
            font-weight: 500;
        }

        .helper-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>‚úàÔ∏è Kayak Link Generator</h1>
            <button class="theme-toggle" id="themeToggle">
                <span>üåó Mode</span>
            </button>
        </header>

        <form id="flightSearchForm">
            <!-- Map Section -->
            <section class="card">
                <h2>Interactive Map Selection</h2>
                <div class="map-mode-btns">
                    <button type="button" id="mapModeDepartTo" class="map-mode-btn active"
                        onclick="setMapMode('departTo')">Destinations (Depart To)</button>
                    <button type="button" id="mapModeReturnFrom" class="map-mode-btn"
                        onclick="setMapMode('returnFrom')">Origins (Return From)</button>
                </div>
                <div id="mapContainer">
                    <div id="map"></div>
                </div>
            </section>

            <!-- Depart From Section -->
            <section class="card">
                <h2>Depart From (Origin)</h2>
                <div id="departFromContainer"></div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="customDepartFrom">Depart From (IATA)</label>
                    <input type="text" id="customDepartFrom" name="customDepartFrom" placeholder="e.g., TPE,TSA,RMQ"
                        style="text-transform:uppercase;">
                    <div class="helper-text">Use checkbox list above or type IATA codes separated by comma. Edits sync
                        both ways.</div>
                </div>
            </section>

            <!-- Depart To Section -->
            <section class="card">
                <h2>Depart To (Destination)</h2>
                <button type="button" class="collapsible-header"
                    onclick="toggleCollapsible('departToCollapsible', this)">
                    Show/Hide Selection List
                </button>
                <div id="departToCollapsible" class="collapsible-content">
                    <div id="departToContainer"></div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="customDepartTo">Depart To (IATA)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="customDepartTo" name="customDepartTo" placeholder="e.g., CTS,NRT,BKK"
                            style="text-transform:uppercase; flex: 1;">
                        <button type="button" class="action-btn" onclick="copyDepartToToReturnFrom()">Copy to Return
                            From ‚Üì</button>
                    </div>
                    <div class="helper-text">Use checkbox list above or type IATA codes separated by comma. Edits sync
                        both ways.</div>
                </div>

                <div class="date-row">
                    <div class="form-group">
                        <label for="departDatePicker">Depart Date</label>
                        <input type="date" id="departDatePicker" name="departDatePicker">
                    </div>
                    <div class="form-group">
                        <label for="departDateFlex">Flexible Days</label>
                        <select id="departDateFlex" name="departDateFlex">
                            <option value="">None</option>
                            <option value="-flexible-1day-before">-flexible-1day-before</option>
                            <option value="-flexible-1day-after">-flexible-1day-after</option>
                            <option value="-flexible-1day">-flexible-1day</option>
                            <option value="-flexible-2days">-flexible-2days</option>
                            <option value="-flexible-3days">-flexible-3days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="favoriteDepartDates">Favorite Depart Dates</label>
                        <select id="favoriteDepartDates" name="favoriteDepartDates">
                            <option value="">Select a favorite depart date</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Return From Section -->
            <section class="card">
                <h2>Return From (Origin)</h2>
                <button type="button" class="collapsible-header"
                    onclick="toggleCollapsible('returnFromCollapsible', this)">
                    Show/Hide Selection List
                </button>
                <div id="returnFromCollapsible" class="collapsible-content">
                    <div id="returnFromContainer"></div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="customReturnFrom">Return From (IATA)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="customReturnFrom" name="customReturnFrom" placeholder="e.g., CTS,NRT,BKK"
                            style="text-transform:uppercase; flex: 1;">
                        <button type="button" class="action-btn" onclick="copyReturnFromToDepartTo()">Copy to Depart To
                            ‚Üë</button>
                    </div>
                    <div class="helper-text">Use checkbox list above or type IATA codes separated by comma. Edits sync
                        both ways.</div>
                </div>

                <div class="date-row">
                    <div class="form-group">
                        <label for="returnDatePicker">Return Date</label>
                        <input type="date" id="returnDatePicker" name="returnDatePicker">
                    </div>
                    <div class="form-group">
                        <label for="returnDateFlex">Flexible Days</label>
                        <select id="returnDateFlex" name="returnDateFlex">
                            <option value="">None</option>
                            <option value="-flexible-1day-before">-flexible-1day-before</option>
                            <option value="-flexible-1day-after">-flexible-1day-after</option>
                            <option value="-flexible-1day">-flexible-1day</option>
                            <option value="-flexible-2days">-flexible-2days</option>
                            <option value="-flexible-3days">-flexible-3days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="favoriteReturnDates">Favorite Return Dates</label>
                        <select id="favoriteReturnDates" name="favoriteReturnDates">
                            <option value="">Select a favorite return date</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="customReturnTo">Other Return To (IATA)</label>
                    <input type="text" id="customReturnTo" name="customReturnTo" placeholder="e.g., TPE,TSA"
                        style="text-transform:uppercase; max-width: 300px;">
                    <div class="helper-text">If left empty, defaults to your Depart From location.</div>
                </div>
            </section>

            <!-- Airlines Section -->
            <section class="card">
                <h2>Airlines Filter</h2>
                <div class="form-group">
                    <label for="airlines">Select Airline Code String</label>
                    <select id="airlines" name="airlines"></select>
                </div>
            </section>
        </form>
    </div>

    <!-- Sticky Footer for generated link -->
    <div id="generatedLink">
        <div class="link-header" onclick="toggleGeneratedLink()">
            <div style="font-weight: bold; color: var(--text-secondary);">Generated Links</div>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="link-content-wrapper">
            <div id="linkContent">Links will appear here...</div>
        </div>
    </div>


    <script>
        // Unified airport data: { IATA: [Êº¢Â≠ó/‰∏≠Êñá, ÊòØÂê¶ËΩâÊ©ü, lat, lng] }
        const airports = {
            // Taiwan (Depart From)
            TPE: ["Ê°ÉÂúí", 0, 25.07, 121.23], TSA: ["ÊùæÂ±±", 0, 25.07, 121.55], RMQ: ["Âè∞‰∏≠", 0, 24.26, 120.59], KHH: ["È´òÈõÑ", 0, 22.57, 120.35],
            // Hokkaido
            WKJ: ["Á®öÂÜÖ", 1, 45.40, 141.80], MMB: ["Â•≥Ê∫ÄÂà•", 1, 43.88, 144.16], MBE: ["Á¥ãÂà•", 1, 44.30, 143.40],
            AKJ: ["Êó≠Â∑ù", 0, 43.67, 142.45], SHB: ["‰∏≠Ê®ôÊ¥•", 1, 43.58, 144.96], KUH: ["ÈáßË∑Ø", 1, 43.04, 144.19],
            OBO: ["Â∏ØÂ∫É", 1, 42.73, 143.22], CTS: ["Êñ∞ÂçÉÊ≠≥", 0, 42.77, 141.69], HKD: ["ÂáΩÈ§®", 0, 41.77, 140.82],
            // Tohoku
            MSJ: ["‰∏âÊ≤¢", 1, 40.70, 141.37], AOJ: ["ÈùíÊ£Æ", 0, 40.73, 140.69], ONJ: ["Â§ßÈ§®ËÉΩ‰ª£", 1, 40.19, 140.35],
            AXT: ["ÁßãÁî∞", 0, 39.61, 140.22], HNA: ["Ëä±Â∑ª", 0, 39.43, 141.13], SYO: ["Â∫ÑÂÜÖ", 1, 38.81, 139.78],
            GAJ: ["Â±±ÂΩ¢", 1, 38.41, 140.37], SDJ: ["‰ªôÂè∞", 0, 38.14, 140.92], FKS: ["Á¶èÂ≥∂", 0, 37.22, 140.43], IBR: ["Ëå®Âüé", 0, 36.18, 140.41],
            // Kanto
            HND: ["ÁæΩÁî∞", 0, 35.54, 139.77], NRT: ["ÊàêÁî∞", 0, 35.77, 140.39], HAC: ["ÂÖ´‰∏àÂ≥∂", 1, 33.11, 139.78],
            // Chubu
            KIJ: ["Êñ∞ÊΩü", 0, 37.95, 139.11], NTQ: ["ËÉΩÁôª", 1, 37.29, 136.95], TOY: ["ÂØåÂ±±", 1, 36.64, 137.18],
            KMQ: ["Â∞èÊùæ", 0, 36.39, 136.40], NKM: ["Â∞èÁâß", 1, 35.25, 136.92], NGO: ["‰∏≠ÈÉ®", 0, 34.85, 136.81], FSZ: ["ÈùúÂ≤°", 1, 34.80, 138.19],
            // Kinki
            KIX: ["Èñ¢Ë•ø", 0, 34.43, 135.23], ITM: ["‰ºä‰∏π", 1, 34.78, 135.44], UKB: ["Á•ûÊà∏", 0, 34.63, 135.22], SHM: ["ÂçóÁ¥ÄÁôΩÊµú", 1, 33.66, 135.36],
            // Chugoku/Shikoku
            TTJ: ["È≥•Âèñ", 1, 35.53, 134.16], YGJ: ["Á±≥Â≠ê", 0, 35.49, 133.23], IZO: ["Âá∫Èõ≤", 1, 35.41, 132.88],
            OKJ: ["Â≤°Â±±", 0, 34.75, 133.85], HIJ: ["Â∫ÉÂ≥∂", 0, 34.44, 132.91], IWJ: ["Ëê©Áü≥Ë¶ã", 1, 34.67, 131.79],
            UBJ: ["Â±±Âè£ÂÆáÈÉ®", 1, 33.93, 131.28], IWK: ["Â≤©ÂõΩ", 1, 34.14, 132.23], TAK: ["È´òÊùæ", 0, 34.21, 134.01],
            TKS: ["Âæ≥Â≥∂", 1, 34.13, 134.60], MYJ: ["ÊùæÂ±±", 1, 33.82, 132.69], KCZ: ["È´òÁü•", 0, 33.54, 133.67],
            // Kyushu/Okinawa
            FUK: ["Á¶èÂ≤°", 0, 33.58, 130.45], HSG: ["‰ΩêË≥Ä", 0, 33.15, 130.30], KKJ: ["Âåó‰πùÂ∑û", 0, 33.84, 131.03],
            OIT: ["Â§ßÂàÜ", 0, 33.47, 131.73], NGS: ["Èï∑Â¥é", 1, 32.91, 129.91], KMJ: ["ÁÜäÊú¨", 0, 32.83, 130.85],
            KMI: ["ÂÆÆÂ¥é", 0, 31.87, 131.44], KOJ: ["ÈπøÂÖêÂ≥∂", 0, 31.80, 130.71], ASJ: ["Â•ÑÁæé", 1, 28.43, 129.71],
            OKA: ["ÈÇ£Ë¶á", 0, 26.19, 127.64], UEO: ["‰πÖÁ±≥Â≥∂", 1, 26.36, 126.71], MMY: ["ÂÆÆÂè§", 1, 24.78, 125.29],
            SHI: ["‰∏ãÂú∞Â≥∂", 1, 24.82, 125.14], ISG: ["Áü≥Âû£", 0, 24.40, 124.24],
            // SEA (No Visa)
            CRK: ["ÂÖãÊãâÂÖã", 0, 15.18, 120.56], MNL: ["È¶¨Â∞ºÊãâ", 0, 14.50, 121.01], CEB: ["ÂÆøÈúß", 0, 10.30, 123.97],
            CNX: ["Ê∏ÖÈÇÅ", 0, 18.76, 98.96], BKK: ["ÊõºË∞∑Á¥†Ëê¨Á¥çÊôÆ", 0, 13.69, 100.75], DMK: ["ÊõºË∞∑ÂªäÊõº", 0, 13.91, 100.60],
            HKT: ["ÊôÆÂêâ", 0, 8.11, 98.30], KBV: ["ÂñÄÊØî", 0, 8.09, 98.98], HDY: ["ÂêàËâæ", 0, 6.93, 100.39],
            LGK: ["Ëò≠Âç°Â®Å", 0, 6.32, 99.73], AOR: ["‰∫ûÁæÖÂ£´Êâì", 1, 6.19, 100.39], PEN: ["Ê™≥Âüé", 0, 5.29, 100.27],
            IPH: ["ÊÄ°‰øù", 0, 4.56, 101.09], KUL: ["ÂêâÈöÜÂù°", 0, 2.74, 101.69], BKI: ["Ê≤ôÂ∑¥", 0, 5.93, 116.05], KCH: ["Âè§Êôâ", 1, 1.48, 110.35],
            SIN: ["Êñ∞Âä†Âù°", 0, 1.36, 103.99],
            PQC: ["ÂØåÂúãÂ≥∂", 0, 10.16, 103.99], VTE: ["Ê∞∏Áèç", 0, 17.98, 102.56],
            MPH: ["Èï∑ÁÅòÂ≥∂", 0, 11.92, 121.95],
            // SEA (Visa Required)
            HAN: ["Ê≤≥ÂÖß", 0, 21.22, 105.80], DAD: ["Â≥¥Ê∏Ø", 0, 16.04, 108.19], SGN: ["ËÉ°ÂøóÊòé", 0, 10.81, 106.65], CXR: ["ËäΩËéä", 0, 11.99, 109.22],
            BWN: ["Ê±∂Ëêä", 0, 4.94, 114.93], PNH: ["ÈáëÈÇä", 0, 11.54, 104.84], CGK: ["ÈõÖÂä†ÈÅî", 0, -6.12, 106.65],
            SUB: ["Ê≥óÊ∞¥", 0, -7.37, 112.78], DPS: ["Â≥áÈáåÂ≥∂", 0, -8.74, 115.16]
        };

        // Helper functions
        const getDisplayName = (code) => {
            const ap = airports[code];
            if (!ap) return code;
            const suffix = ap[1] ? '+' : '';
            return `${code}_${ap[0]}${suffix}`;
        };
        const getCoords = (code) => airports[code] ? [airports[code][2], airports[code][3]] : null;
        const isTransfer = (code) => airports[code]?.[1] === 1;

        // Region groupings (using IATA codes only)
        const destHokkaido = ["WKJ", "MMB", "MBE", "AKJ", "SHB", "KUH", "OBO", "CTS", "HKD"].map(getDisplayName);
        const destTohoku = ["MSJ", "AOJ", "ONJ", "AXT", "HNA", "SYO", "GAJ", "SDJ", "FKS", "IBR"].map(getDisplayName);
        const destKanto = ["HND", "NRT", "HAC"].map(getDisplayName);
        const destChubu = ["KIJ", "NTQ", "TOY", "KMQ", "NKM", "NGO", "FSZ"].map(getDisplayName);
        const destKinki = ["KIX", "ITM", "UKB", "SHM"].map(getDisplayName);
        const destChugokuShikoku = ["TTJ", "YGJ", "IZO", "OKJ", "HIJ", "IWJ", "UBJ", "IWK", "TAK", "TKS", "MYJ", "KCZ"].map(getDisplayName);
        const destKyushuOkinawa = ["FUK", "HSG", "KKJ", "OIT", "NGS", "KMJ", "KMI", "KOJ", "ASJ", "OKA", "UEO", "MMY", "SHI", "ISG"].map(getDisplayName);
        const destSea = ["CRK", "MNL", "CEB", "MPH", "CNX", "BKK", "DMK", "HKT", "KBV", "HDY", "VTE", "LGK", "AOR", "PEN", "IPH", "KUL", "BKI", "KCH", "SIN", "PQC"].map(getDisplayName);
        const destSeaVisa = ["HAN", "DAD", "CXR", "SGN", "BWN", "PNH", "CGK", "SUB", "DPS"].map(getDisplayName);

        // Legacy compatibility: airportCoords object derived from airports
        const airportCoords = Object.fromEntries(Object.entries(airports).map(([k, v]) => [k, [v[2], v[3]]]));

        const favoriteDepartDates = [
            "2026-02-24-flexible-3days",
            "2026-03-31-flexible-3days",
            "2026-04-02-flexible-1day",
            "2026-04-28-flexible-3days",
            "2026-06-16-flexible-3days",
            "2026-09-22-flexible-3days",
            "2026-10-06-flexible-3days",
            "2026-10-23-flexible-1day",
            "2026-12-22-flexible-3days",
        ];
        const favoriteReturnDates = [
            "2026-03-02-flexible-1day",
            "2026-04-07-flexible-1day",
            "2026-04-10-flexible-3days",
            "2026-05-05-flexible-2days",
            "2026-06-23-flexible-2days",
            "2026-10-01-flexible-3days",
            "2026-10-13-flexible-2days",
            "2026-10-29-flexible-3days",
            "2026-12-30-flexible-3days",
            "2027-01-04-flexible-3days",
        ];
        const airlinesOptions = [
            "-3U,TW,HO,HU,HX,BX,MF,UO,MU,9C,ZH,FM,NX,KE,CA,OZ,7C,CX,CZ,HB,LJ",
            "-3U,TW,HO,HU,HX,BX,MF,UO,MU,9C,ZH,FM,NX,KE,CA,OZ,7C,CX,CZ,HB,LJ,PR,Z2,5J",
            "QH,MH,AC,AE,EK,B7,VN,NH,VU,BC,JL,JX,BR,SQ,CI,H1,TG,TK,PG",
        ];

        // Flatpickr JS
        const flatpickrScript = document.createElement('script');
        flatpickrScript.src = "https://cdn.jsdelivr.net/npm/flatpickr";
        document.head.appendChild(flatpickrScript);

        flatpickrScript.onload = function () {
            const today = new Date().toISOString().split('T')[0];
            flatpickr("#departDatePicker", { dateFormat: "Y-m-d", minDate: today });
            flatpickr("#returnDatePicker", { dateFormat: "Y-m-d", minDate: today });
        };

        function createCheckboxTable(containerId, name, IATAsList) {
            const container = document.getElementById(containerId);
            const table = document.createElement('table');
            const headerRow = document.createElement('tr');

            // Create header row with "Select All" checkboxes
            IATAsList.forEach((IATAs, colIndex) => {
                const headerCell = document.createElement('th');
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';

                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.id = `${name}-selectAll-${colIndex}`;
                // Keep reference to handle map updates later
                selectAllCheckbox.setAttribute('data-select-all-group', `${name}-group-${colIndex}`);

                selectAllCheckbox.addEventListener('change', function () {
                    const checkboxes = document.querySelectorAll(`input[name="${name}"][data-col="${colIndex}"]`);
                    checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);

                    // Sync to text input for departTo and returnFrom
                    if (name === 'departTo') {
                        syncCheckboxesToInput('departTo', 'customDepartTo');
                    } else if (name === 'returnFrom') {
                        syncCheckboxesToInput('returnFrom', 'customReturnFrom');
                    }

                    generateLink(); // Update link on select all
                    if (map) updateMapMarkers();
                });

                const label = document.createElement('label');
                label.htmlFor = selectAllCheckbox.id;
                label.textContent = 'Select All';
                label.className = 'checkbox-label';
                label.style.fontWeight = 'bold';

                div.appendChild(selectAllCheckbox);
                div.appendChild(label);
                headerCell.appendChild(div);
                headerRow.appendChild(headerCell);
            });

            table.appendChild(headerRow);

            // Determine the number of rows needed
            const numRows = Math.max(...IATAsList.map(IATAs => IATAs.length));

            for (let i = 0; i < numRows; i++) {
                const row = document.createElement('tr');

                for (let j = 0; j < IATAsList.length; j++) {
                    const cell = document.createElement('td');
                    const IATA = IATAsList[j][i];

                    if (IATA !== undefined) {
                        const div = document.createElement('div');
                        div.style.display = 'flex';
                        div.style.alignItems = 'center';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        const code = IATA.split("_")[0];
                        checkbox.id = `${name}-${code}`;
                        checkbox.name = name;
                        checkbox.value = code;
                        checkbox.setAttribute('data-col', j);

                        const label = document.createElement('label');
                        label.htmlFor = checkbox.id;
                        label.textContent = IATA;
                        label.className = 'checkbox-label';

                        div.appendChild(checkbox);
                        div.appendChild(label);
                        cell.appendChild(div);
                    }
                    row.appendChild(cell);
                }
                table.appendChild(row);
            }
            container.appendChild(table);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
        }

        // Populate favorite date dropdowns
        populateSelect('favoriteDepartDates', favoriteDepartDates);
        populateSelect('favoriteReturnDates', favoriteReturnDates);

        // È†êË®≠ÂãæÈÅ∏ TPEÔºå‰∏¶Ëá™ÂãïÁîüÊàêÈÄ£Áµê
        window.addEventListener('DOMContentLoaded', function () {
            const tpeCheckbox = document.getElementById('departFrom-TPE');
            if (tpeCheckbox) tpeCheckbox.checked = true;
            generateLink();
        });

        // Áï∂ÈÅ∏Êìá favoriteDepartDates ÊôÇÔºåËá™ÂãïÂ°´ÂÖ•Êó•ÊúüÂíå flexible daysÔºå‰∏¶Ëá™ÂãïÁîüÊàêÈÄ£Áµê
        document.getElementById('favoriteDepartDates').addEventListener('change', function () {
            const val = this.value;
            if (!val) return;
            const [date, ...flexible] = val.split('-flexible');
            document.getElementById('departDatePicker').value = date;
            document.getElementById('departDateFlex').value = flexible.length ? '-flexible' + flexible.join('-flexible') : '';
            generateLink();
        });

        // Áï∂ÈÅ∏Êìá favoriteReturnDates ÊôÇÔºåËá™ÂãïÂ°´ÂÖ•Êó•ÊúüÂíå flexible daysÔºå‰∏¶Ëá™ÂãïÁîüÊàêÈÄ£Áµê
        document.getElementById('favoriteReturnDates').addEventListener('change', function () {
            const val = this.value;
            if (!val) return;
            const [date, ...flexible] = val.split('-flexible');
            document.getElementById('returnDatePicker').value = date;
            document.getElementById('returnDateFlex').value = flexible.length ? '-flexible' + flexible.join('-flexible') : '';
            generateLink();
        });

        // Toggle generated link section
        function toggleGeneratedLink() {
            const linkSection = document.getElementById('generatedLink');
            linkSection.classList.toggle('collapsed');
        }

        // ========== Two-way Sync: Checkboxes <-> Text Input ==========

        // Update text input from checkbox selections
        function syncCheckboxesToInput(checkboxName, inputId) {
            const checkedCodes = Array.from(document.querySelectorAll(`input[name="${checkboxName}"]:checked`)).map(cb => cb.value);
            document.getElementById(inputId).value = checkedCodes.join(',');
        }

        // Update checkboxes from text input (and keep any codes not in checkbox list)
        function syncInputToCheckboxes(inputId, checkboxName) {
            const inputEl = document.getElementById(inputId);
            const rawValue = (inputEl.value || '').toUpperCase();
            const codes = rawValue.split(',').map(s => s.trim()).filter(s => /^[A-Z]{3}$/.test(s));

            // Get all available checkbox codes
            const allCheckboxes = document.querySelectorAll(`input[name="${checkboxName}"]`);
            const availableCodes = new Set();
            allCheckboxes.forEach(cb => availableCodes.add(cb.value));

            // Uncheck all first
            allCheckboxes.forEach(cb => cb.checked = false);

            // Check matching ones
            codes.forEach(code => {
                const checkbox = document.getElementById(`${checkboxName}-${code}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });

            // Update map markers
            if (map) updateMapMarkers();
            generateLink();
        }

        // Áõ£ËÅΩÊâÄÊúâË°®ÂñÆÊ¨Ñ‰ΩçËá™ÂãïÁîüÊàêÈÄ£Áµê
        function addAutoGenerateListeners() {
            const form = document.getElementById('flightSearchForm');
            form.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', generateLink);
            });

            // Sync checkboxes -> text input when departFrom checkboxes change
            document.querySelectorAll('input[name="departFrom"]').forEach(cb => {
                cb.addEventListener('change', function () {
                    syncCheckboxesToInput('departFrom', 'customDepartFrom');
                });
            });

            // Sync checkboxes -> text input when departTo or returnFrom checkboxes change
            document.querySelectorAll('input[name="departTo"]').forEach(cb => {
                cb.addEventListener('change', function () {
                    syncCheckboxesToInput('departTo', 'customDepartTo');
                    if (map) updateMapMarkers();
                });
            });

            document.querySelectorAll('input[name="returnFrom"]').forEach(cb => {
                cb.addEventListener('change', function () {
                    syncCheckboxesToInput('returnFrom', 'customReturnFrom');
                    if (map) updateMapMarkers();
                });
            });

            // Sync text input -> checkboxes when user types (on input event for real-time)
            document.getElementById('customDepartFrom').addEventListener('input', function () {
                syncInputToCheckboxes('customDepartFrom', 'departFrom');
            });

            document.getElementById('customDepartTo').addEventListener('input', function () {
                syncInputToCheckboxes('customDepartTo', 'departTo');
            });

            document.getElementById('customReturnFrom').addEventListener('input', function () {
                syncInputToCheckboxes('customReturnFrom', 'returnFrom');
            });
        }
        window.addEventListener('DOMContentLoaded', addAutoGenerateListeners);

        createCheckboxTable('departFromContainer', 'departFrom', [["TPE", "TSA", "RMQ", "KHH"]]);
        createCheckboxTable('departToContainer', 'departTo', [destHokkaido, destTohoku, destKanto, destChubu, destKinki, destChugokuShikoku, destKyushuOkinawa, destSea, destSeaVisa]);
        createCheckboxTable('returnFromContainer', 'returnFrom', [destHokkaido, destTohoku, destKanto, destChubu, destKinki, destChugokuShikoku, destKyushuOkinawa, destSea, destSeaVisa]);
        populateSelect('airlines', airlinesOptions);

        // Set default checked for TPE and sync initial state
        window.addEventListener('DOMContentLoaded', function () {
            // Default: check TPE
            const tpeCheckbox = document.getElementById('departFrom-TPE');
            if (tpeCheckbox) {
                tpeCheckbox.checked = true;
            }
            // Sync initial checkbox state to text input
            syncCheckboxesToInput('departFrom', 'customDepartFrom');
        });

        // Helper: parse comma-separated IATA codes
        function parseCustomIATA(inputId) {
            const raw = (document.getElementById(inputId)?.value || '').trim().toUpperCase();
            if (!raw) return [];
            return raw.split(',').map(s => s.trim()).filter(s => /^[A-Z]{3}$/.test(s));
        }

        function generateLink() {
            // Depart From - now uses the synced text input directly
            const departFrom = parseCustomIATA('customDepartFrom').join(',');

            // Depart To - now uses the synced text input directly
            const departTo = parseCustomIATA('customDepartTo').join(',');

            // Return From - now uses the synced text input directly
            const returnFrom = parseCustomIATA('customReturnFrom').join(',');

            // Return To (defaults to departFrom if not specified)
            const customReturnToList = parseCustomIATA('customReturnTo');
            const returnTo = customReturnToList.length > 0 ? customReturnToList.join(',') : departFrom;

            const departDateRaw = document.getElementById("departDatePicker").value;
            const departDateFlex = document.getElementById("departDateFlex").value;
            const departDate = departDateRaw + departDateFlex;
            const returnDateRaw = document.getElementById("returnDatePicker").value;
            const returnDateFlex = document.getElementById("returnDateFlex").value;
            const returnDate = returnDateRaw + returnDateFlex;
            const airlines = document.getElementById("airlines").value;

            const linkContent = document.getElementById("linkContent");

            // Ê™¢Êü•Âá∫ÁôºÊó•ÊúüÊòØÂê¶Â§ßÊñºÂõûÁ®ãÊó•Êúü
            if (departDateRaw && returnDateRaw && departDateRaw > returnDateRaw) {
                linkContent.innerHTML = '<span style="color:#ef4444; font-weight:bold;">‚ö†Ô∏è Âá∫ÁôºÊó•Êúü‰∏çÂèØÊôöÊñºÂõûÁ®ãÊó•ÊúüÔºÅ (Depart date must be before return date)</span>';
                return;
            }

            const departToStr = departTo ? `/${departFrom}-${departTo}` : '';
            const departtDateStr = departDate ? `/${departDate}` : '';
            const returnToStr = returnFrom ? `/${returnFrom}-${returnTo}` : '';
            const returntDateStr = returnDate ? `/${returnDate}` : '';

            const kayakLink = `https://www.tw.kayak.com/flights${departToStr}${departtDateStr}${returnToStr}${returntDateStr}/?&sort=price_a&fs=airlines=${airlines}`;

            // Thai Vietjet Air link generation
            const vzStartDate = departDateRaw ? departDateRaw.split('-').reverse().join('%2F') : '';
            const vzEndDate = returnDateRaw ? returnDateRaw.split('-').reverse().join('%2F') : '';
            const vzLink = `https://th.vietjetair.com/select-flight-cheap?tripType=roundtrip&currency=twd&from_where=${departFrom}&start=${vzStartDate}&to_where=${departTo}&end=${vzEndDate}&adultCount=1&childCount=0&infantCount=0&promoCode=&findLowestFare=1`;

            linkContent.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <div>
                            <span style="background:#ff690f; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-right:8px;">KAYAK</span>
                            <a href="${kayakLink}" target="_blank">${kayakLink}</a>
                        </div>
                        <div>
                            <span style="background:#d31e1e; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-right:8px;">Vietjet</span>
                            <a href="${vzLink}" target="_blank">${vzLink.replace('\&', '&amp;')}</a>
                        </div>
                    </div>
                `;
        }

        // Check for saved theme preference in localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        } else {
            document.documentElement.setAttribute('data-theme', 'dark'); // Default to dark theme
        }

        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (map) {
                setTimeout(() => map.invalidateSize(), 300);
            }
        });

        // ---------------- MAP LOGIC ----------------
        let map;
        let mapMarkers = {};
        let currentMapTarget = 'departTo'; // 'departTo' or 'returnFrom' - default to departTo

        function initMap() {
            if (map) return;
            map = L.map('map').setView([25, 125], 4); // Center broadly on Asia/Japan

            // Add OpenStreetMap tiles - dark mode friendly tiles if possible, but standard is fine
            // We can check theme and switch tiles, but let's stick to standard for now or use a neutral one
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        // Initialize map on page load
        window.addEventListener('DOMContentLoaded', function () {
            initMap();
            setTimeout(() => {
                map.invalidateSize();
                updateMapMarkers();
            }, 100);
        });

        // Set map mode (departTo or returnFrom)
        function setMapMode(mode) {
            currentMapTarget = mode;

            // Update button styles
            document.getElementById('mapModeDepartTo').classList.remove('active');
            document.getElementById('mapModeReturnFrom').classList.remove('active');

            if (mode === 'departTo') {
                document.getElementById('mapModeDepartTo').classList.add('active');
            } else {
                document.getElementById('mapModeReturnFrom').classList.add('active');
            }

            updateMapMarkers();
        }

        // Toggle collapsible sections
        function toggleCollapsible(id, btnElement) {
            const content = document.getElementById(id);
            const isOpen = content.classList.contains('open');

            content.classList.toggle('open');
            btnElement.classList.toggle('active');
        }

        function updateMapMarkers() {
            if (!map) return;

            // clear existing markers
            for (let code in mapMarkers) {
                map.removeLayer(mapMarkers[code]);
            }
            mapMarkers = {};

            // Get currently checked items
            const checkedBoxes = document.querySelectorAll(`input[name="${currentMapTarget}"]:checked`);
            const checkedCodes = new Set(Array.from(checkedBoxes).map(cb => cb.value));

            // Populate markers
            // Iterate over all checkboxes in the target container to find valid codes
            const allCheckboxes = document.querySelectorAll(`input[name="${currentMapTarget}"]`);
            const relevantCodes = new Set();
            allCheckboxes.forEach(cb => relevantCodes.add(cb.value));

            // Helper function to create and add a marker
            const createMarker = (code) => {
                const isSelected = checkedCodes.has(code);
                const needsTransfer = isTransfer(code);
                const ap = airports[code];
                const displayName = ap ? ap[0] : code;

                // Color: Green if selected, Blue if not selected
                const color = isSelected ? '#10b981' : '#3b82f6';
                const radius = isSelected ? 14 : 10;  // Larger markers
                const fillOpacity = isSelected ? 0.9 : 0.7;

                let marker;
                if (needsTransfer) {
                    // Triangle shape for transfer airports (using DivIcon with CSS triangle)
                    const size = isSelected ? 24 : 18;  // Larger triangles
                    const triangleIcon = L.divIcon({
                        className: 'triangle-marker',
                        html: `<div style="
                            width: 0; 
                            height: 0; 
                            border-left: ${size / 2}px solid transparent;
                            border-right: ${size / 2}px solid transparent;
                            border-bottom: ${size}px solid ${color};
                            filter: drop-shadow(0 0 2px rgba(255,255,255,0.8));
                        "></div>`,
                        iconSize: [size, size],
                        iconAnchor: [size / 2, size]
                    });
                    marker = L.marker(airportCoords[code], { icon: triangleIcon, zIndexOffset: 0 }).addTo(map);
                } else {
                    // Circle for direct flight airports (higher z-index to be on top)
                    marker = L.circleMarker(airportCoords[code], {
                        color: 'white',
                        fillColor: color,
                        fillOpacity: fillOpacity,
                        weight: 2,
                        radius: radius
                    }).addTo(map);
                    marker.bringToFront();
                }

                const typeIcon = needsTransfer ? '‚ñ≤' : '‚óè';
                const typeText = needsTransfer ? 'ÈúÄËΩâÊ©ü' : 'Áõ¥È£õ';
                const typeColor = needsTransfer ? '#f59e0b' : '#3b82f6';

                const selectIcon = isSelected ? '‚úì' : 'üëÜ';
                const selectText = isSelected ? 'Â∑≤ÈÅ∏Âèñ' : 'ÈªûÊìäÈÅ∏Âèñ';
                const selectColor = isSelected ? '#10b981' : 'var(--text-secondary)';

                const popupContent = `
                    <div class="airport-popup">
                        <div class="airport-popup-header">
                            <span class="airport-popup-name">${displayName}</span>
                            <span class="airport-popup-iata">${code}</span>
                        </div>
                        <div class="airport-popup-row">
                            <span style="color: ${typeColor}">${typeIcon}</span>
                            <span class="airport-popup-status" style="color: ${typeColor}">${typeText}</span>
                        </div>
                        <div class="airport-popup-row" style="color: ${selectColor}">
                            <span>${selectIcon}</span>
                            <span>${selectText}</span>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent, {
                    offset: [0, -10],       // Move popup up
                    autoPan: false,          // Don't auto-pan map
                    closeOnClick: true       // Close when clicking elsewhere
                });

                marker.on('click', () => {
                    toggleSelection(code);
                });

                // Use mouseover to show popup, but don't close on mouseout to prevent flickering
                marker.on('mouseover', function (e) {
                    this.openPopup();
                });

                // Anti-flicker: track if mouse is on popup
                let isMouseOnPopup = false;
                let closeTimeout = null;

                // Close popup only when mouse leaves both marker and popup
                const tryClosePopup = (markerRef) => {
                    if (closeTimeout) clearTimeout(closeTimeout);
                    closeTimeout = setTimeout(() => {
                        const popup = markerRef.getPopup();
                        if (popup && !isMouseOnPopup) {
                            const popupEl = popup.getElement();
                            const markerEl = markerRef._path || markerRef._icon;
                            const isOverPopup = popupEl && popupEl.matches(':hover');
                            const isOverMarker = markerEl && markerEl.matches(':hover');
                            if (!isOverPopup && !isOverMarker) {
                                markerRef.closePopup();
                            }
                        }
                    }, 150);
                };

                marker.on('mouseout', function (e) {
                    tryClosePopup(this);
                });

                // Attach popup events after popup opens
                marker.on('popupopen', function (e) {
                    const popupEl = e.popup.getElement();
                    if (popupEl) {
                        popupEl.addEventListener('mouseenter', () => {
                            isMouseOnPopup = true;
                            if (closeTimeout) clearTimeout(closeTimeout);
                        });
                        popupEl.addEventListener('mouseleave', () => {
                            isMouseOnPopup = false;
                            tryClosePopup(marker);
                        });
                    }
                });

                mapMarkers[code] = marker;
            };

            // First pass: Add transfer airports (triangles) - they will be below
            relevantCodes.forEach(code => {
                if (airportCoords[code] && isTransfer(code)) {
                    createMarker(code);
                }
            });

            // Second pass: Add direct flight airports (circles) - they will be on top
            relevantCodes.forEach(code => {
                if (airportCoords[code] && !isTransfer(code)) {
                    createMarker(code);
                }
            });
        }

        function toggleSelection(code) {
            if (!currentMapTarget) return;

            // Find the checkbox
            const checkbox = document.getElementById(`${currentMapTarget}-${code}`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;

                // Sync to text input
                const inputId = currentMapTarget === 'departTo' ? 'customDepartTo' : 'customReturnFrom';
                syncCheckboxesToInput(currentMapTarget, inputId);

                generateLink(); // Update link

                // Update marker visual
                updateMapMarkers();
            }
        }

        // Copy Depart To selections to Return From
        function copyDepartToToReturnFrom() {
            // Copy checkboxes
            const departToCheckboxes = document.querySelectorAll('input[name="departTo"]');
            departToCheckboxes.forEach(cb => {
                const returnFromCb = document.getElementById(`returnFrom-${cb.value}`);
                if (returnFromCb) {
                    returnFromCb.checked = cb.checked;
                }
            });

            // Copy custom input
            const customDepartTo = document.getElementById('customDepartTo').value;
            document.getElementById('customReturnFrom').value = customDepartTo;

            generateLink();
            if (currentMapTarget === 'returnFrom') updateMapMarkers();
        }

        // Copy Return From selections to Depart To
        function copyReturnFromToDepartTo() {
            // Copy checkboxes
            const returnFromCheckboxes = document.querySelectorAll('input[name="returnFrom"]');
            returnFromCheckboxes.forEach(cb => {
                const departToCb = document.getElementById(`departTo-${cb.value}`);
                if (departToCb) {
                    departToCb.checked = cb.checked;
                }
            });

            // Copy custom input
            const customReturnFrom = document.getElementById('customReturnFrom').value;
            document.getElementById('customDepartTo').value = customReturnFrom;

            generateLink();
            if (currentMapTarget === 'departTo') updateMapMarkers();
        }

    </script>
</body>

</html>